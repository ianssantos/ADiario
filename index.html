<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alimento Diário - Devocional</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        /* (Mantendo o mesmo CSS anterior) */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --text-color: #333;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f9f9f9;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            gap: 2rem;
        }
        
        .sidebar {
            flex: 0 0 250px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1rem;
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }
        
        .content {
            flex: 1;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            min-height: 500px;
        }
        
        .week-nav, .day-nav {
            margin-bottom: 1.5rem;
        }
        
        .week-nav h3, .day-nav h3 {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .week-list, .day-list {
            list-style: none;
        }
        
        .week-item, .day-item {
            margin-bottom: 0.5rem;
        }
        
        .week-link, .day-link {
            display: block;
            padding: 0.5rem;
            border-radius: 4px;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s;
        }
        
        .week-link:hover, .day-link:hover {
            background-color: var(--light-color);
        }
        
        .week-link.active, .day-link.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .devotional-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-color);
        }
        
        .devotional-title {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
        }
        
        .devotional-date {
            color: var(--secondary-color);
            font-weight: bold;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .bible-reading, .prayer-reading {
            background-color: var(--light-color);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--secondary-color);
        }
        
        .bible-reading h3, .prayer-reading h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }
        
        .devotional-content {
            line-height: 1.8;
            font-size: 1.1rem;
        }
        
        .devotional-content p {
            margin-bottom: 1.5rem;
            text-align: justify;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--secondary-color);
            font-size: 1.2rem;
        }
        
        .error {
            text-align: center;
            padding: 2rem;
            color: var(--accent-color);
        }
        
        .file-input-container {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                position: static;
                max-height: none;
            }
            
            .devotional-title {
                font-size: 1.3rem;
            }
            
            .devotional-content {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Alimento Diário</h1>
        <p>Devocional - A Criação do Homem</p>
    </header>
    
    <div class="container">
        <aside class="sidebar">
            <div class="file-input-container">
                <input type="file" id="pdfFile" accept=".pdf" style="display: none;">
                <button onclick="document.getElementById('pdfFile').click()" style="
                    background: var(--secondary-color);
                    color: white;
                    border: none;
                    padding: 0.5rem 1rem;
                    border-radius: 4px;
                    cursor: pointer;
                    width: 100%;
                ">Carregar PDF</button>
                <p style="font-size: 0.9rem; margin-top: 0.5rem; color: #666;">Ou use o arquivo ad.pdf na pasta</p>
            </div>
            
            <div class="week-nav">
                <h3>Semana</h3>
                <ul class="week-list" id="weekList">
                    <!-- Será preenchido dinamicamente -->
                </ul>
            </div>
            
            <div class="day-nav">
                <h3>Dia</h3>
                <ul class="day-list" id="dayList">
                    <!-- Será preenchido dinamicamente -->
                </ul>
            </div>
        </aside>
        
        <main class="content" id="content">
            <div class="loading" id="loadingMessage">
                Carregando devocional...
            </div>
        </main>
    </div>

    <script>
        // Configuração do PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        // Mapeamento de dias da semana
        const weekDays = {
            'SEGUNDA-FEIRA': 'Segunda',
            'TERÇA FEIRA': 'Terça',
            'QUARTA-FEIRA': 'Quarta',
            'QUINTA-FEIRA': 'Quinta',
            'SEXTA-FEIRA': 'Sexta',
            'SÁBADO': 'Sábado',
            'DOMINGO': 'Domingo'
        };
        
        // Variáveis globais
        let currentPdf = null;
        let devotionalData = {};
        
        // Função para carregar o PDF
        async function loadPdf(pdfUrl = 'ad.pdf') {
            try {
                showLoading('Carregando PDF...');
                
                console.log('Tentando carregar PDF:', pdfUrl);
                const loadingTask = pdfjsLib.getDocument(pdfUrl);
                currentPdf = await loadingTask.promise;
                
                console.log('PDF carregado com sucesso, número de páginas:', currentPdf.numPages);
                
                // Extrair conteúdo do PDF
                await extractContent();
                
                // Corrigir nomes dos dias
                fixDayNames();
                
                // Renderizar navegação
                renderWeekNavigation();
                
                hideLoading();
                
            } catch (error) {
                console.error('Erro ao carregar PDF:', error);
                hideLoading();
                showError(`Não foi possível carregar o PDF: ${error.message}`);
            }
        }
        
        // Função para corrigir nomes dos dias
        function fixDayNames() {
            const correctedData = {};
            
            for (let week in devotionalData) {
                correctedData[week] = {};
                
                for (let dayKey in devotionalData[week]) {
                    // Corrigir o nome do dia - remover "LEITURA BÍBLICA" e outros textos extras
                    let correctedDay = dayKey;
                    
                    // Remover "LEITURA BÍBLICA" e variações
                    correctedDay = correctedDay.replace(/LEITURA BÍBLICA/gi, '').trim();
                    correctedDay = correctedDay.replace(/LEITURA/gi, '').trim();
                    correctedDay = correctedDay.replace(/BÍBLICA/gi, '').trim();
                    
                    // Garantir que temos um nome de dia válido
                    if (isValidDayName(correctedDay)) {
                        correctedData[week][correctedDay] = devotionalData[week][dayKey];
                    } else {
                        // Se não for válido, tentar encontrar o nome do dia no texto
                        const foundDay = findDayName(dayKey);
                        if (foundDay) {
                            correctedData[week][foundDay] = devotionalData[week][dayKey];
                        } else {
                            // Se ainda não encontrar, manter o original
                            correctedData[week][dayKey] = devotionalData[week][dayKey];
                        }
                    }
                }
            }
            
            devotionalData = correctedData;
            console.log('Dados corrigidos:', devotionalData);
        }
        
        // Função para verificar se é um nome de dia válido
        function isValidDayName(dayName) {
            const validDays = [
                'SEGUNDA-FEIRA', 'TERÇA FEIRA', 'QUARTA-FEIRA', 
                'QUINTA-FEIRA', 'SEXTA-FEIRA', 'SÁBADO', 'DOMINGO'
            ];
            return validDays.includes(dayName);
        }
        
        // Função para encontrar nome do dia no texto
        function findDayName(text) {
            const dayPatterns = [
                /SEGUNDA-FEIRA/i,
                /TERÇA FEIRA/i,
                /QUARTA-FEIRA/i,
                /QUINTA-FEIRA/i,
                /SEXTA-FEIRA/i,
                /SÁBADO/i,
                /DOMINGO/i
            ];
            
            for (let pattern of dayPatterns) {
                const match = text.match(pattern);
                if (match) {
                    return match[0].toUpperCase();
                }
            }
            return null;
        }
        
        // Função para extrair conteúdo do PDF
        async function extractContent() {
            devotionalData = {};
            
            console.log('Iniciando extração do PDF...');
            
            for (let pageNum = 1; pageNum <= currentPdf.numPages; pageNum++) {
                try {
                    const page = await currentPdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    
                    // Processar cada item de texto individualmente
                    processTextItems(textContent.items, pageNum);
                    
                } catch (error) {
                    console.error(`Erro ao processar página ${pageNum}:`, error);
                }
            }
            
            console.log('Extração bruta concluída:', devotionalData);
        }
        
        // Função para processar itens de texto individualmente
        function processTextItems(textItems, pageNum) {
            let currentWeek = null;
            let currentDay = null;
            let currentSection = null;
            
            for (let i = 0; i < textItems.length; i++) {
                const item = textItems[i];
                const text = item.str.trim();
                
                if (!text) continue;
                
                // Detectar semana (ex: "SEMANA 1")
                const weekMatch = text.match(/SEMANA\s+(\d+)/i);
                if (weekMatch) {
                    currentWeek = parseInt(weekMatch[1]);
                    console.log(`Encontrada Semana ${currentWeek}`);
                    continue;
                }
                
                // Detectar dia da semana (separadamente da semana)
                const dayMatch = findDayName(text);
                if (dayMatch && currentWeek) {
                    currentDay = dayMatch;
                    currentSection = 'header';
                    
                    if (!devotionalData[currentWeek]) {
                        devotionalData[currentWeek] = {};
                    }
                    
                    if (!devotionalData[currentWeek][currentDay]) {
                        devotionalData[currentWeek][currentDay] = {
                            bibleReading: '',
                            prayerReading: '',
                            title: '',
                            content: ''
                        };
                    }
                    
                    console.log(`Encontrado: Semana ${currentWeek}, ${currentDay}`);
                    continue;
                }
                
                // Se temos uma semana e dia ativos, processar o conteúdo
                if (currentWeek && currentDay) {
                    const currentDevotional = devotionalData[currentWeek][currentDay];
                    
                    // Detectar leitura bíblica
                    if ((text.includes('Leitura bíblica:') || text.includes('Leitura bíblica')) && !currentDevotional.bibleReading) {
                        currentSection = 'bibleReading';
                        let bibleText = text.replace(/Leitura bíblica:?\s*/i, '').trim();
                        
                        // Coletar próximos itens até encontrar "Ler com oração" ou novo dia
                        for (let j = i + 1; j < textItems.length; j++) {
                            const nextText = textItems[j].str.trim();
                            if (nextText.includes('Ler com oração') || findDayName(nextText) || /SEMANA\s+\d+/.test(nextText)) {
                                break;
                            }
                            if (nextText) bibleText += ' ' + nextText;
                        }
                        
                        currentDevotional.bibleReading = bibleText.trim();
                        continue;
                    }
                    
                    // Detectar ler com oração
                    if ((text.includes('Ler com oração:') || text.includes('Ler com oração')) && !currentDevotional.prayerReading) {
                        currentSection = 'prayerReading';
                        let prayerText = '';
                        
                        // Coletar próximo item (geralmente o versículo)
                        for (let j = i + 1; j < textItems.length; j++) {
                            const nextText = textItems[j].str.trim();
                            if (nextText && !nextText.includes('Leitura bíblica') && 
                                !findDayName(nextText) && !/SEMANA\s+\d+/.test(nextText)) {
                                prayerText = nextText;
                                break;
                            }
                        }
                        
                        currentDevotional.prayerReading = prayerText;
                        continue;
                    }
                    
                    // Detectar título - vem depois do "Ler com oração" e antes do conteúdo
                    if (currentSection === 'prayerReading' && !currentDevotional.title && 
                        text && text.length > 10 && !text.includes('Leitura') && !text.includes('Ler com')) {
                        
                        // Verificar se é um título (texto em maiúsculas ou formato de título)
                        if (text === text.toUpperCase() || text.length < 100) {
                            currentDevotional.title = text;
                            currentSection = 'content';
                            console.log(`Título encontrado: ${text}`);
                            continue;
                        }
                    }
                    
                    // Coletar conteúdo - tudo depois do título
                    if (currentSection === 'content' && text && !isHeaderOrFooter(text)) {
                        // Parar se encontrar novo dia ou semana
                        if (findDayName(text) || /SEMANA\s+\d+/.test(text)) {
                            currentSection = null;
                            continue;
                        }
                        
                        // Adicionar ao conteúdo
                        currentDevotional.content += text + ' ';
                    }
                }
            }
        }
        
        // Função para verificar se é cabeçalho ou rodapé
        function isHeaderOrFooter(text) {
            const ignorePatterns = [
                'Anote abaixo',
                'Ore e faça',
                'Luz na palavra',
                'Direção',
                'Admoestação',
                'Leitura de apoio',
                '=====',
                /^\d+$/,
                'Acesso ao',
                'mensagem',
                '©',
                'Editora',
                'CITAÇÕES BÍBLICAS',
                'SUMÁRIO',
                'PEDRO DONG',
                'ALIMENTO DIÁRIO'
            ];
            
            return ignorePatterns.some(pattern => {
                if (typeof pattern === 'string') {
                    return text.includes(pattern);
                } else {
                    return pattern.test(text);
                }
            });
        }
        
        // Funções auxiliares
        function showLoading(message = 'Carregando PDF...') {
            const loadingElement = document.getElementById('loadingMessage');
            if (loadingElement) {
                loadingElement.style.display = 'block';
                loadingElement.textContent = message;
            }
        }
        
        function hideLoading() {
            const loadingElement = document.getElementById('loadingMessage');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }
        
        function showError(message) {
            const content = document.getElementById('content');
            if (content) {
                content.innerHTML = `
                    <div class="error">
                        <h2>Erro ao carregar o devocional</h2>
                        <p>${message}</p>
                        <p>Por favor, carregue o arquivo PDF manualmente usando o botão acima.</p>
                    </div>
                `;
            }
        }
        
        // Função para renderizar navegação de semanas
        function renderWeekNavigation() {
            const weekList = document.getElementById('weekList');
            weekList.innerHTML = '';
            
            const weeks = Object.keys(devotionalData).sort((a, b) => a - b);
            
            if (weeks.length === 0) {
                weekList.innerHTML = '<li>Nenhuma semana encontrada</li>';
                return;
            }
            
            weeks.forEach(weekNum => {
                const li = document.createElement('li');
                li.className = 'week-item';
                
                const a = document.createElement('a');
                a.href = '#';
                a.className = 'week-link';
                a.textContent = `Semana ${weekNum}`;
                a.dataset.week = weekNum;
                
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    renderDayNavigation(parseInt(weekNum));
                    
                    // Ativar link selecionado
                    document.querySelectorAll('.week-link').forEach(link => {
                        link.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Renderizar primeiro dia da semana
                    const firstDay = Object.keys(devotionalData[weekNum])[0];
                    if (firstDay) {
                        renderDevotional(parseInt(weekNum), firstDay);
                        
                        // Ativar primeiro dia
                        document.querySelectorAll('.day-link').forEach(link => {
                            link.classList.remove('active');
                        });
                        const dayLink = document.querySelector(`.day-link[data-day="${firstDay}"]`);
                        if (dayLink) {
                            dayLink.classList.add('active');
                        }
                    }
                });
                
                li.appendChild(a);
                weekList.appendChild(li);
            });
            
            // Ativar primeira semana e renderizar primeiro dia
            const firstWeekLink = document.querySelector('.week-link');
            if (firstWeekLink) {
                firstWeekLink.classList.add('active');
                const firstWeek = parseInt(firstWeekLink.dataset.week);
                renderDayNavigation(firstWeek);
                const firstDay = Object.keys(devotionalData[firstWeek])[0];
                if (firstDay) {
                    renderDevotional(firstWeek, firstDay);
                }
            }
        }
        
        // Função para renderizar navegação de dias
        function renderDayNavigation(weekNum) {
            const dayList = document.getElementById('dayList');
            dayList.innerHTML = '';
            
            const weekData = devotionalData[weekNum];
            if (!weekData) {
                dayList.innerHTML = '<li>Nenhum dia encontrado</li>';
                return;
            }
            
            const days = Object.keys(weekData);
            
            days.forEach(day => {
                const li = document.createElement('li');
                li.className = 'day-item';
                
                const a = document.createElement('a');
                a.href = '#';
                a.className = 'day-link';
                a.textContent = weekDays[day] || day;
                a.dataset.day = day;
                
                a.addEventListener('click', function(e) {
                    e.preventDefault();
                    renderDevotional(weekNum, day);
                    
                    // Ativar link selecionado
                    document.querySelectorAll('.day-link').forEach(link => {
                        link.classList.remove('active');
                    });
                    this.classList.add('active');
                });
                
                li.appendChild(a);
                dayList.appendChild(li);
            });
            
            // Ativar primeiro dia
            const firstDayLink = document.querySelector('.day-link');
            if (firstDayLink) {
                firstDayLink.classList.add('active');
            }
        }
        
        // Função para renderizar o devocional
        function renderDevotional(weekNum, day) {
            const content = document.getElementById('content');
            const devotional = devotionalData[weekNum]?.[day];
            
            if (!devotional) {
                content.innerHTML = `
                    <div class="error">
                        <h2>Devocional não encontrado</h2>
                        <p>Semana ${weekNum}, ${weekDays[day] || day}</p>
                    </div>
                `;
                return;
            }
            
            // Se não tem título, usar um padrão baseado no dia
            const title = devotional.title || `Devocional - ${weekDays[day] || day}`;
            
            content.innerHTML = `
                <div class="devotional-header">
                    <h2 class="devotional-title">${title}</h2>
                    <div class="devotional-date">Semana ${weekNum} - ${weekDays[day] || day}</div>
                </div>
                
                <div class="bible-reading">
                    <h3>Leitura Bíblica</h3>
                    <p>${devotional.bibleReading || 'Leitura bíblica não disponível'}</p>
                </div>
                
                <div class="prayer-reading">
                    <h3>Ler com Oração</h3>
                    <p>${devotional.prayerReading || 'Versículo não disponível'}</p>
                </div>
                
                <div class="devotional-content">
                    ${formatContent(devotional.content)}
                </div>
            `;
        }
        
        // Função para formatar o conteúdo
        function formatContent(content) {
            if (!content) return '<p>Conteúdo não disponível</p>';
            
            // Limpar e quebrar em parágrafos
            const cleanContent = content.replace(/\s+/g, ' ').trim();
            const sentences = cleanContent.split(/(?<=[.!?])\s+/);
            let paragraphs = [];
            let currentParagraph = '';
            
            for (let sentence of sentences) {
                if ((currentParagraph + sentence).length < 500) {
                    currentParagraph += sentence + ' ';
                } else {
                    if (currentParagraph) paragraphs.push(currentParagraph.trim());
                    currentParagraph = sentence + ' ';
                }
            }
            
            if (currentParagraph) paragraphs.push(currentParagraph.trim());
            
            return paragraphs.map(p => `<p>${p}</p>`).join('');
        }
        
        // Configurar upload de arquivo
        document.getElementById('pdfFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type === 'application/pdf') {
                const fileUrl = URL.createObjectURL(file);
                loadPdf(fileUrl);
            }
        });
        
        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            loadPdf().catch(error => {
                console.error('Erro ao carregar PDF inicial:', error);
                showError('Não foi possível carregar o PDF automaticamente.');
            });
        });
    </script>
</body>
</html>